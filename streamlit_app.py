import streamlit as st
import pandas as pd
import plotly.express as px
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score
from sklearn.tree import DecisionTreeClassifier
from sklearn.neighbors import KNeighborsClassifier

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(page_title="üêß Penguin Classifier", layout="wide")
st.title('üêß Penguin Classifier - –û–±—É—á–µ–Ω–∏–µ –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ')
st.write("## –†–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞—Å–µ—Ç–æ–º –ø–∏–Ω–≥–≤–∏–Ω–æ–≤")

# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
@st.cache_data
def load_data():
    return pd.read_csv("https://raw.githubusercontent.com/dataprofessor/data/master/penguins_cleaned.csv")

df = load_data()

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ 10 —Å—Ç—Ä–æ–∫
st.subheader("üîé –°–ª—É—á–∞–π–Ω—ã–µ 10 —Å—Ç—Ä–æ–∫")
st.dataframe(df.sample(10), use_container_width=True)

# –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
st.subheader("üìä –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö")
col1, col2 = st.columns(2)
with col1:
    fig1 = px.histogram(df, x="species", color="island", barmode="group", title="–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–∏–¥–æ–≤ –ø–æ –æ—Å—Ç—Ä–æ–≤–∞–º")
    st.plotly_chart(fig1, use_container_width=True)
with col2:
    fig2 = px.scatter(df, x="bill_length_mm", y="flipper_length_mm", color="species", title="–î–ª–∏–Ω–∞ –∫–ª—é–≤–∞ vs –î–ª–∏–Ω–∞ –∫—Ä—ã–ª–∞")
    st.plotly_chart(fig2, use_container_width=True)

# Target Mean Encoding
st.subheader("üß† –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π")
df_encoded = df.copy()
for col in ['island', 'sex']:
    means = df_encoded.groupby(col)['species'].apply(lambda x: x.map({k: i for i, k in enumerate(x.unique())}).mean())
    df_encoded[col + '_mean'] = df_encoded[col].map(means)
df_encoded.drop(columns=['island', 'sex'], inplace=True)

# Train/Test Split
X = df_encoded.drop(columns=['species'])
y = df_encoded['species']
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
models = {
    'Decision Tree': DecisionTreeClassifier(random_state=42),
    'KNN': KNeighborsClassifier()
}

results = []
for name, model in models.items():
    model.fit(X_train, y_train)
    acc_train = accuracy_score(y_train, model.predict(X_train))
    acc_test = accuracy_score(y_test, model.predict(X_test))
    results.append({
        'Model': name,
        'Train Accuracy': round(acc_train, 2),
        'Test Accuracy': round(acc_test, 2)
    })

st.write("### üìã –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π –ø–æ —Ç–æ—á–Ω–æ—Å—Ç–∏")
st.table(pd.DataFrame(results))

# –°–∞–π–¥–±–∞—Ä ‚Äî –≤–≤–æ–¥ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
st.sidebar.header("üîÆ –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º")

island_input = st.sidebar.selectbox("–û—Å—Ç—Ä–æ–≤", df['island'].unique())
sex_input = st.sidebar.selectbox("–ü–æ–ª", df['sex'].unique())
bill_length = st.sidebar.slider("–î–ª–∏–Ω–∞ –∫–ª—é–≤–∞ (–º–º)", float(df['bill_length_mm'].min()), float(df['bill_length_mm'].max()), float(df['bill_length_mm'].mean()))
bill_depth = st.sidebar.slider("–ì–ª—É–±–∏–Ω–∞ –∫–ª—é–≤–∞ (–º–º)", float(df['bill_depth_mm'].min()), float(df['bill_depth_mm'].max()), float(df['bill_depth_mm'].mean()))
flipper_length = st.sidebar.slider("–î–ª–∏–Ω–∞ –∫—Ä—ã–ª–∞ (–º–º)", float(df['flipper_length_mm'].min()), float(df['flipper_length_mm'].max()), float(df['flipper_length_mm'].mean()))
body_mass = st.sidebar.slider("–ú–∞—Å—Å–∞ —Ç–µ–ª–∞ (–≥)", float(df['body_mass_g'].min()), float(df['body_mass_g'].max()), float(df['body_mass_g'].mean()))

# Target mean encoding –Ω–∞ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
def encode_feature(value, colname):
    mapping = df.groupby(colname)['species'].apply(lambda x: x.map({k: i for i, k in enumerate(x.unique())}).mean())
    return mapping.get(value, 0.0)

island_mean = encode_feature(island_input, 'island')
sex_mean = encode_feature(sex_input, 'sex')

user_data = pd.DataFrame([{
    'bill_length_mm': bill_length,
    'bill_depth_mm': bill_depth,
    'flipper_length_mm': flipper_length,
    'body_mass_g': body_mass,
    'island_mean': island_mean,
    'sex_mean': sex_mean
}])

# –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π
st.sidebar.subheader("–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è:")
for name, model in models.items():
    prediction = model.predict(user_data)[0]
    st.sidebar.write(f"**{name} –ø—Ä–µ–¥—Å–∫–∞–∑–∞–ª:** {prediction}")
